#!../../runscript

LOG "Syslinux..."

_build_syslinux() {
#   cd syslinux-$vers 
#   _ make
#   cd ../..
}

_fetch_sources() {
   LOG "   Prepating isolinux..."
   ESRC_URI=http://www.kernel.org/pub/linux/utils/boot/syslinux/syslinux-$vers.tar.gz
   [[ -d tmp ]] || mkdir tmp
   [[ -e tmp/syslinux-$vers.tar.gz ]] && return 0
   _ wget $ESRC_URI -O tmp/syslinux-$vers.tar.gz
   #_ sudo apt-get -y --force-yes build-dep syslinux
   cd tmp
   _ tar xzf syslinux-$vers.tar.gz
   cd ..
}

_make_isolinux() {
   LOG "   Make isolinux image"
   [[ -d $target/isolinux ]] || mkdir -p $target/isolinux
   cp tmp/syslinux-$vers/core/isolinux.bin $target/isolinux
   cp patches/* $target/isolinux
   cp splash/splash.rle $target/isolinux
}

_make_syslinux() {
   LOG "   Make syslinux image"
   [[ -d $target ]] || mkdir -p $target
   cp patches/* $target
   cp splash/splash.rle $target
}

_make_pxelinux() {
   LOG "   Make pxelinux image"
   [[ -d $target/pxelinux.cfg ]] || mkdir -p $target/pxelinux.cfg
   cp tmp/syslinux-$vers/core/pxelinux.0 $target/pxelinux.0
   cat patches/syslinux.cfg | sed 's/\/boot/\/srv\/tftp/g;' > $target/pxelinux.cfg/default
}

_splash() {
   LOG "   Splash image"
   #cd splash
   #pngtopnm splash.png | gzip -9 > splash.ppm.gz
   #gzip -cd splash.ppm.gz | ppmtolss16 \#000000=0 \#d0d0d0=7 \#f6f6f6=15 > splash.lss
   #cp splash.lss $target
   #cd ..
}

vers=3.70
target=../tmp/isoimage
[[ ! -e $target ]] && mkdir -p $target
_fetch_sources
_make_syslinux
_make_isolinux
_make_pxelinux
